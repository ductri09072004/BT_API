# Monitoring Makefile for BT_API

.PHONY: install deploy status logs clean

# CÃ i Ä‘áº·t monitoring stack
install:
	@echo "ğŸš€ Installing Prometheus + Grafana..."
	@bash install-monitoring.sh

# Deploy full monitoring vá»›i dashboard
deploy:
	@echo "ğŸ”§ Deploying complete monitoring stack..."
	@bash deploy-monitoring.sh

# Kiá»ƒm tra tráº¡ng thÃ¡i monitoring
status:
	@echo "ğŸ“Š Monitoring Status:"
	@kubectl get pods -n monitoring
	@echo ""
	@kubectl get services -n monitoring

# Xem logs Grafana
logs:
	@kubectl logs -f deployment/prometheus-grafana -n monitoring

# Import a dashboard from grafana.com (ID 11835)
import-11835:
	@echo "ğŸ“¥ Importing Grafana.com dashboard ID 11835..."
	@python3 import-grafana-11835.py
	@echo "âœ… Done. Open Grafana to view the dashboard."

# Import dashboard by arbitrary Grafana.com ID: make import-id ID=12345
import-id:
	@if [ -z "$(ID)" ]; then echo "Usage: make import-id ID=12345"; exit 1; fi
	@echo "ğŸ“¥ Importing Grafana.com dashboard ID $(ID)..."
	@python3 import-grafana.py --id $(ID)
	@echo "âœ… Done. Open Grafana to view the dashboard."

# Generate and import service traffic dashboard from local metrics
service-traffic:
	@echo "ğŸ› ï¸ Generating service traffic dashboard..."
	@python3 generate-service-traffic-dashboard.py
	@echo "ğŸ“¥ Importing dashboard into Grafana..."
	@python3 import-service-traffic.py
	@echo "âœ… Service traffic dashboard imported."

# Normalize and import user-provided service traffic dashboard JSON
service-traffic-normalize:
	@echo "ğŸ”§ Normalizing bt-api-service-traffic.json to match local metrics..."
	@python3 normalize-and-import-service-traffic.py
	@echo "âœ… Normalized dashboard imported."

# Port forward Ä‘á»ƒ truy cáº­p local
port-forward:
	@echo "ğŸŒ Starting port forwarding..."
	@echo "Grafana: http://localhost:30000"
	@echo "Prometheus: http://localhost:30001"
	@kubectl port-forward -n monitoring svc/prometheus-grafana 30000:80 &
	@kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 30001:9090 &

# XÃ³a monitoring stack
clean:
	@echo "ğŸ§¹ Cleaning up monitoring stack..."
	@helm uninstall prometheus -n monitoring
	@kubectl delete namespace monitoring

# Kiá»ƒm tra metrics tá»« services
metrics:
	@echo "ğŸ“ˆ BT_API Services Metrics:"
	@kubectl top pods -n bt-api
	@echo ""
	@kubectl top nodes



